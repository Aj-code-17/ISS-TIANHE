<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>ISS & Tiangong Tracker</title>
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@2.1.9/dist/maplibre-gl.css" />
  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    .marker {
      background-size: cover;
      width: 30px;
      height: 30px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/maplibre-gl@2.1.9/dist/maplibre-gl.js"></script>
  <script>
    // initialize map
    const map = new maplibregl.Map({
      container: 'map',
      style: 'https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json',
      center: [0, 0],
      zoom: 1,
      interactive: false
    });

    // create marker elements
    function createMarkerElement(iconUrl) {
      const el = document.createElement('div');
      el.className = 'marker';
      el.style.backgroundImage = `url(${iconUrl})`;
      return el;
    }
    const issMarker = new maplibregl.Marker({ element: createMarkerElement('iss.png') })
      .setLngLat([0, 0])
      .addTo(map);
    const tiangongMarker = new maplibregl.Marker({ element: createMarkerElement('tiangong.png') })
      .setLngLat([0, 0])
      .addTo(map);

    // live tracking of ISS
    async function getISSLocation() {
      const resp = await fetch('https://api.wheretheiss.at/v1/satellites/25544');
      const d = await resp.json();
      return [d.longitude, d.latitude];
    }
    async function updateISS() {
      try {
        const loc = await getISSLocation();
        issMarker.setLngLat(loc);
      } catch (e) {
        console.error('ISS fetch error', e);
      }
    }
    updateISS();
    setInterval(updateISS, 5000);

    // load satellite.js
    const satScript = document.createElement('script');
    satScript.src = 'https://cdn.jsdelivr.net/npm/satellite.js@4.0.0/dist/satellite.min.js';
    document.head.appendChild(satScript);

    let satReady = false, mapReady = false;
    satScript.onload = () => { satReady = true; tryDraw(); };
    map.on('load', () => { mapReady = true; tryDraw(); });

    function tryDraw() {
      if (!satReady || !mapReady) return;
      drawOrbits();
    }

    function computeOrbit(tle1, tle2, minutes = 90) {
      const satrec = satellite.twoline2satrec(tle1, tle2);
      const now = new Date();
      const coords = [];
      for (let i = 0; i <= minutes; i++) {
        const t = new Date(now.getTime() + i * 60 * 1000);
        const pv = satellite.propagate(satrec, t);
        if (pv.position) {
          const gmst = satellite.gstime(t);
          const geo = satellite.eciToGeodetic(pv.position, gmst);
          coords.push([ satellite.degreesLong(geo.longitude), satellite.degreesLat(geo.latitude) ]);
        }
      }
      return coords;
    }

    function drawOrbits() {
      // TLEs
      const issT1 = '1 25544U 98067A   25058.66013045  .00061406  00000+0  10908-2 0  9991';
      const issT2 = '2 25544  51.6385 129.5122 0005976 320.1405 159.8209 15.49585351498173';
      const tianheT1 = '1 48274U 21035A   25063.02436798  .00034128  00000-0  39625-3 0  9997';
      const tianheT2 = '2 48274  41.4650 301.0393 0007466 280.0498  79.9498 15.61023996219718';

      const issCoords = computeOrbit(issT1, issT2);
      const tianheCoords = computeOrbit(tianheT1, tianheT2);

      map.addSource('issOrbit', {
        type: 'geojson',
        data: { type: 'Feature', geometry: { type: 'LineString', coordinates: issCoords } }
      });
      map.addLayer({
        id: 'issOrbit',
        type: 'line',
        source: 'issOrbit',
        paint: { 'line-color': 'red', 'line-width': 2, 'line-dasharray': [4,4] }
      });

      map.addSource('tianheOrbit', {
        type: 'geojson',
        data: { type: 'Feature', geometry: { type: 'LineString', coordinates: tianheCoords } }
      });
      map.addLayer({
        id: 'tianheOrbit',
        type: 'line',
        source: 'tianheOrbit',
        paint: { 'line-color': 'blue', 'line-width': 2, 'line-dasharray': [4,4] }
      });

      console.log('ISS orbit points:', issCoords.length, 'Tiangong orbit points:', tianheCoords.length);
    }

  </script>
</body>
</html>
