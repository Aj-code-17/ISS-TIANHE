<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Satellite Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <style>
        body { margin: 0; padding: 0; }
        #map-container { position: absolute; top: 0; bottom: 0; width: 100%; height: 100vh; }
        .marker {
            background-size: cover;
            width: 40px; 
            height: 40px; 
            transform: translate(-50%, -50%); 
        }

        /* ðŸ’¡ NEW CSS FIX: Overrides any dash style applied by JS or plugins */
        .leaflet-container svg path {
            stroke-dasharray: none !important;
        }
    </style>
</head>
<body>
    <div id="map-container"></div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20n69z7k77ySdaG4J+b2v7y7BqP+Y3J/sTz5hFm+j6M="
            crossorigin=""></script>
    
    <script src="https://cdn.jsdelivr.net/npm/satellite.js@4.0.0/dist/satellite.min.js"></script>

    <script>
        // --- ðŸ’¥ CRITICAL FIX: Custom Leaflet Marker Type ðŸ’¥ ---
        L.NonWrappingMarker = L.Marker.extend({
            _setLatLng: function (latlng) {
                const mapCenterLng = this._map.getCenter().lng;
                let lng = latlng.lng;
                while (lng > mapCenterLng + 180) {
                    lng -= 360;
                }
                while (lng < mapCenterLng - 180) {
                    lng += 360;
                }
                this._latlng = L.latLng(latlng.lat, lng); 
                if (this._icon) {
                    this._reset();
                }
            }
        });

        L.nonWrappingMarker = function (latlng, options) {
            return new L.NonWrappingMarker(latlng, options);
        };
        // --- END CUSTOM MARKER ---


        // Initialize map
        let issMap = L.map('map-container', {
            maxBounds: [[-90, -180], [90, 180]],
            maxBoundsViscosity: 1,
            worldCopyJump: true // Crucial for multi-world rendering
        }).setView([30, 0], 1.5);

        // Add a Tile Layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(issMap);

        // ISS Marker (Placeholder for icon URL)
        let issIcon = L.icon({
            iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/b/ba/International_Space_Station_%28Expedition_58_Patch%29.svg/500px-International_Space_Station_%28Expedition_58_Patch%29.svg.png',
            iconSize: [70, 50]
        });
        let marker = L.nonWrappingMarker([0, 0], { icon: issIcon, title: 'ISS Position' }).addTo(issMap);

        // Tiangong Marker
        const tiangongIcon = L.icon({
            iconUrl: 'tiangong.png', // Ensure this file is present
            iconSize: [50, 50]
        });
        const tiangongMarker = L.nonWrappingMarker([0, 0], { icon: tiangongIcon, title: 'Tiangong' }).addTo(issMap);
        let tiangongPath = [];

        // ðŸ’¡ Polyline Definition: Solid line options (dashArray: null included for safety)
        const tiangongPolyline = L.polyline([], { 
            color: 'blue', 
            weight: 3, 
            opacity: 0.8,
            dashArray: null // Explicitly sets to solid
        }).addTo(issMap); 


        // --- TLE Data ---
        const TLE = {
            TIANGONG: {
                line1: '1 48274U 21035A   25333.06763102  .00014333  00000-0  18674-3 0  9990',
                line2: '2 48274  41.4664  99.6574 0010668 290.8853  69.0842 15.58380651261895'
            }
        };

        // --- TLE UTILITY FUNCTIONS ---
        function getTiangongPosition(tleLine1, tleLine2, date) {
            const satrec = satellite.twoline2satrec(tleLine1, tleLine2);
            const positionAndVelocity = satellite.propagate(satrec, date);

            if (!positionAndVelocity.position) return null;

            const positionGd = satellite.eciToGeodetic(positionAndVelocity.position, satellite.gstime(date));
            const longitude = satellite.degreesLong(positionGd.longitude);
            const latitude = satellite.degreesLat(positionGd.latitude);

            return L.latLng(latitude, longitude); 
        }

        // --- ISS Function (API Update) ---
        const getIssLocation = async () => {
            try {
                const resp = await fetch('https://api.wheretheiss.at/v1/satellites/25544');
                const d = await resp.json();
                marker.setLatLng(L.latLng(d.latitude, d.longitude)); 
            } catch (e) {
                console.error('ISS fetch error', e);
            }
        };
        setInterval(getIssLocation, 5000);


        // --- Tiangong Functions (TLE Update and Path Logic) ---
        function updateTiangongPosition() {
            const now = new Date();
            const newLatLng = getTiangongPosition(TLE.TIANGONG.line1, TLE.TIANGONG.line2, now);

            if (newLatLng) {
                const currentLng = tiangongMarker.getLatLng().lng;
                const newLng = newLatLng.lng;
                
                // 1. Update Marker: Handled by L.NonWrappingMarker (Straight Line Fix)
                tiangongMarker.setLatLng(newLatLng);

                // 2. Path Line Logic: Check for the jump
                if (tiangongPath.length > 0 && Math.abs(newLng - currentLng) > 180) {
                    // Reset path if antimeridian crossed
                    tiangongPath = [];
                }
                
                // Push the new point, then update the polyline
                tiangongPath.push(newLatLng);
                tiangongPolyline.setLatLngs(tiangongPath);
            }
        }

        // Initial Calls
        // Wait for Satellite.js to load (already loaded by script tag, but waiting for 'onload' is safer)
        if (typeof satellite !== 'undefined') {
             updateTiangongPosition();
             setInterval(updateTiangongPosition, 1000);
        } else {
             // Fallback for script loading
             const satScriptElement = document.querySelector('script[src*="satellite.js"]');
             if (satScriptElement) {
                satScriptElement.onload = () => {
                    updateTiangongPosition();
                    setInterval(updateTiangongPosition, 1000);
                };
             }
        }
    </script>
</body>
</html>
