<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ISS Tracker</title>
    <link href="https://unpkg.com/maplibre-gl@2.1.9/dist/maplibre-gl.css" rel="stylesheet" />
    <link rel="stylesheet" href="style.css" />
    <style>
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            height: 600px;
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <script src="https://unpkg.com/maplibre-gl@2.1.9/dist/maplibre-gl.js"></script>
    <script>
        // Dynamically load Satellite.js
        const satScript = document.createElement('script');
        satScript.src = 'https://cdn.jsdelivr.net/npm/satellite.js@4.0.0/dist/satellite.min.js';
        document.head.appendChild(satScript);

        // Initialize MapLibre GL map
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                "version": 8,
                "sources": {
                    "stamen-toner": {
                        "type": "raster",
                        "tiles": [
                            "https://stamen-tiles.a.ssl.fastly.net/toner-background/{z}/{x}/{y}.png"
                        ],
                        "tileSize": 256
                    }
                },
                "layers": [{
                    "id": "stamen-toner",
                    "type": "raster",
                    "source": "stamen-toner",
                    "minzoom": 0,
                    "maxzoom": 20
                }]
            },
            center: [0, 0],
            zoom: 1
        });


        // ISS and Tiangong markers (using MapLibre GL)
        const issMarker = new maplibregl.Marker({ color: 'red' }).setLngLat([0, 0]).addTo(map);
        const tiangongMarker = new maplibregl.Marker({ color: 'blue' }).setLngLat([0, 0]).addTo(map);

        // Live Tracking Functions (modified for MapLibre GL)
        async function updateISSLocation() {
            const location = await getISSLocation();
            if (location) {
                issMarker.setLngLat(location);
            }
        }

        async function fetchTiangongPosition() {
            const apiKey = '53LGUU-BLJ9LG-MJLP5Y-5F62'; // Replace with your N2YO.com API key if available
            const noradId = 48274; // NORAD ID for Tiangong
            const observerLat = 0; // Your observer latitude
            const observerLng = 0; // Your observer longitude
            const observerAlt = 0; // Observer altitude (meters)
            const seconds = 1; // Seconds for prediction

            const proxyUrl = 'https://corsproxy.io/?'; // Replace with your proxy URL if needed
            const url = encodeURI(
                `${proxyUrl}https://api.n2yo.com/rest/v1/satellite/positions/${noradId}/${observerLat}/${observerLng}/${observerAlt}/${seconds}/?apiKey=${apiKey}`
            );

            try {
                const response = await fetch(url);
                const data = await response.json();
                const position = data.positions[0];

                tiangongMarker.setLngLat([position.satlatitude, position.satlongitude]);

            } catch (error) {
                console.error('Error fetching Tiangong position:', error);
            }
        }

        // Initial live tracking calls and intervals
        updateISSLocation();
        setInterval(updateISSLocation, 5000);
        fetchTiangongPosition();
        setInterval(fetchTiangongPosition, 5000);


        // ----- PREDICTED ORBIT CALCULATION -----
        satScript.onload = function () {
            // Function to compute predicted orbit points using Satellite.js
            function computePredictedOrbit(tle1, tle2, durationMinutes = 90) {
                const satrec = satellite.twoline2satrec(tle1, tle2);
                const now = new Date();
                const points = [];
                for (let i = 0; i <= durationMinutes; i++) {
                    const time = new Date(now.getTime() + i * 60 * 1000);
                    const positionAndVelocity = satellite.propagate(satrec, time);
                    if (positionAndVelocity.position) {
                        const gmst = satellite.gstime(time);
                        const positionGd = satellite.eciToGeodetic(positionAndVelocity.position, gmst);
                        const latitude = satellite.degreesLat(positionGd.latitude);
                        const longitude = satellite.degreesLong(positionGd.longitude);
                        points.push([longitude, latitude]); // Note: longitude, then latitude for MapLibre GL
                    }
                }
                return points;
            }

            const issTle1 = '1 25544U 98067A   25049.36865051  .00017018  00000-0  30289-3 0  9996';
            const issTle2 = '2 25544  51.6389 175.5124 0004060 333.0365 122.1476 15.50242656496730';
            const tiangongTle1 = '1 54216U 22143A   25048.94388909  .00037270  00000-0  45292-3 0  9993';
            const tiangongTle2 = '2 54216  41.4672  26.6806 0005254 200.9588 159.1035 15.59818964130880';

            const issOrbitPoints = computePredictedOrbit(issTle1, issTle2);
            const issOrbitLine = new maplibregl.Polyline({ color: 'red', width: 2 }).setLngLats(issOrbitPoints).addTo(map);

            const tiangongOrbitPoints = computePredictedOrbit(tiangongTle1, tiangongTle2);
            const tiangongOrbitLine = new maplibregl.Polyline({ color: 'blue', width: 2 }).setLngLats(tiangongOrbitPoints).addTo(map);
        };
    </script>
</body>

</html>
