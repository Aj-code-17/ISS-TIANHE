<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISS Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map {
            width: 100%;
            height: 600px;
        }

        #tiangong-info {
            padding: 20px;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <div id="tiangong-info">
        <h1>Tiangong Current Position</h1>
        <p id="position">Loading...</p>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/satellite.js@4.0.0/dist/satellite.min.js"></script>
    <script>
        // Initialize Map
        const map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // ISS Tracking
        const issIcon = L.icon({
            iconUrl: 'iss.png', // Corrected path
            iconSize: [70, 50]
        });
        const issMarker = L.marker([0, 0], { icon: issIcon }).addTo(map);
        let issPath = [];
        const issPolyline = L.polyline([], { color: 'red' }).addTo(map);

        // Tiangong Tracking
        const tiangongIcon = L.icon({
            iconUrl: 'tiangong.png', // Corrected path
            iconSize: [50, 50]
        });
        const tiangongMarker = L.marker([0, 0], { icon: tiangongIcon }).addTo(map);
        let tiangongPath = [];
        const tiangongPolyline = L.polyline([], { color: 'blue' }).addTo(map);

        // ISS Functions
        async function updateISSLocation() {
            try {
                const response = await fetch('https://api.wheretheiss.at/v1/satellites/25544');
                const data = await response.json();
                const location = [data.latitude, data.longitude];

                issMarker.setLatLng(location);
                issPath.push(location);
                issPolyline.setLatLngs(issPath);
            } catch (error) {
                console.error('Error updating ISS:', error);
            }
        }

        // Tiangong Functions
        async function fetchTiangongPosition() {
            const noradId = 48274;
            const apiKey = '53LGUU-BLJ9LG-MJLP5Y-5F62';
            const proxyUrl = 'https://corsproxy.io/?';
            const url = `${proxyUrl}https://api.n2yo.com/rest/v1/satellite/positions/${noradId}/0/0/0/1/?apiKey=${apiKey}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.positions && data.positions.length > 0) {
                    const pos = data.positions[0];
                    const location = [pos.satlatitude, pos.satlongitude];

                    document.getElementById('position').textContent =
                        `Latitude: ${pos.satlatitude.toFixed(4)}, Longitude: ${pos.satlongitude.toFixed(4)}`;

                    tiangongMarker.setLatLng(location);
                    tiangongPath.push(location);
                    tiangongPolyline.setLatLngs(tiangongPath);
                }
            } catch (error) {
                console.error('Error fetching Tiangong:', error);
            }
        }

        // Orbit Prediction
        function calculateOrbit(tle1, tle2) {
            const satrec = satellite.twoline2satrec(tle1, tle2);
            const points = [];
            const now = new Date();

            for (let i = 0; i < 90; i++) {
                const date = new Date(now.getTime() + (i * 60 * 1000));
                const {
                    position
                } = satellite.propagate(satrec, date);

                if (position) {
                    const gmst = satellite.gstime(date);
                    const geodetic = satellite.eciToGeodetic(position, gmst);

                    let longitude = satellite.degreesLong(geodetic.longitude);
                    let latitude = satellite.degreesLat(geodetic.latitude);

                    // Wrap longitude to stay within -180 to 180 range
                    longitude = (longitude + 180) % 360 - 180;

                    points.push([latitude, longitude]);
                }
            }
            return points;
        }

        // Initialize Updates
        setInterval(updateISSLocation, 5000);
        setInterval(fetchTiangongPosition, 5000);
        updateISSLocation();
        fetchTiangongPosition();

        // Add Orbit Prediction
        const tiangongTLE = [
            '1 48274U 21035A   23071.46905046  .00033621  00000-0  22303-3 0  9991',
            '2 48274  41.4732  80.1553 0016146 226.8877 133.0410 15.61100352 26834'
        ];

        const tiangongOrbitPoints = calculateOrbit(...tiangongTLE);
        L.polyline(tiangongOrbitPoints, {
            color: 'orange'
        }).addTo(map);


        const issTLE = [
            '1 25544U 98067A   23071.69539875  .00000424  00000-0  17087-4 0  9997',
            '2 25544  51.6416 161.2721 0006524 133.6808 226.2576 15.50580964 80598'
        ];

        const issOrbitPoints = calculateOrbit(...issTLE);
        L.polyline(issOrbitPoints, {
            color: 'red'
        }).addTo(map); // Added to map
    </script>
</body>

</html>
